<html>
	<head>
		<title>Architectural Design</title>
		<meta charset="utf-8">

		<link rel="icon" href="img/web-icon.png" type="image/gif" sizes="32x32">
	    <link rel="stylesheet" href="../z-lib/stylesheets/joint.css" />
		<link rel="stylesheet" href="../z-lib/jquery-ui-1.11.4/jquery-ui.min.css" />

		<link rel="stylesheet" href="model_ui_styles.css">

	    <script src="../z-lib/jquery-2.1.4.min.js"></script>
	    <script src="../z-lib/lodash.min.js"></script>
	    <script src="../z-lib/backbone-min.js"></script>
    	<script src="../z-lib/joint.js"></script>
    	<script src="../z-lib/joint.shapes.uml.js"></script>
			<script src="../z-lib/jquery-ui-1.11.4/jquery-ui.min.js"></script>

    	<script src="js/class_collection.js"></script>

    	<script src="js/data-model-manipulation.js"></script>
    	<script src="js/transformations.js"></script>
    	<script src="js/site_map_elements.js"></script>
    	<script src="js/site-map_manipulation.js"></script>

    	<script>
    	var tabTemplate = "<li><a href='#{href}'>#{label}</a></li>",
      			distTableTemplate = "<table><tr>"
					+	"<th>Element</th>"
					+	"<th>Create</th>"
					+	"<th>Read</th>"
					+	"<th>Update</th>"
					+	"<th>Delete</th>"
					+ "</tr>${rows}</table>",
      			permissionField = "<tr>"
						+ "<td>"
						+	"${classname}"
						+ "</td>"
						+ "<td>"
						+ 	"<input type=\"checkbox\">"
						+ "</td>"
						+ "<td>"
						+ 	"<input type=\"checkbox\">"
						+ "</td>"
						+ "<td>"
						+ 	"<input type=\"checkbox\">"
						+ "</td>"
						+ "<td>"
						+ 	"<input type=\"checkbox\">"
						+ "</td>"
					+ "</tr>",
					distTable = "";
  			$(function() {
    		var tabTitle = $( "#tab_title" );

    		var userTabs = $( "#user-tabs" ).tabs();

    		var usergroupInput = $( "#usergroupInput" ).dialog({
      		autoOpen: false,
      		modal: true,
      		position: { my: "center", at: "center", of: $("#tb_permissions") },
      		buttons: {
		     	Add: function() {
		        	addTab();
		        	$( this ).dialog( "close" );
		        },
		        Cancel: function() {
		        	$( this ).dialog( "close" );
		        }
		      	},
		      	close: function() {

		      	}
    		});

    function addTab(label) {

       	var label = tabTitle.val() || "ANONYMOUS",
        id = "tabs-" + tabTitle.val(),
        li = $( tabTemplate.replace( /#\{href\}/g, "#" + id ).replace( /#\{label\}/g, label ) ),
        tabContentHtml = "Tab content here.";

	    userTabs.find( ".ui-tabs-nav" ).append( li );
	    userTabs.append( "<div id='" + id + "'><p>" + distTable + "</p></div>" );
	    userTabs.tabs( "refresh" );
    }

    $( "#add_tab" )
      .button()
      .click(function() {
        usergroupInput.dialog( "open" );
      });
  });
			function uiSidebarToggle(sidebar){
				alert(sidebar);
				sidebar.style.width = '2px';
			}
			function openElementPanel(){
				alert("PANEL");
			}
  		</script>

	</head>
	<body onload="init()">
		<div id="menu">
			<h1 style="display: inline-block;">|||</h1>
			<!--<button id="load">Project</button>-->
			<button id="upload">Generate Code</button>
			<!--<button>Project Description</button>-->
			<!--<button>Messages</button>-->
			<h1 style="display: inline-block;">|||</h1>
		</div>
		<aside id="project_sidebar">
	        <a class="model-tab" href="#data-model">Data<br>Model</a>
	        <a class="model-tab" href="#tb_processes">Process<br>Model</a>
	        <!--<a class="model-tab" href="#tb_distribution">Distribution<br>Model</a>-->
	        <a class="model-tab" href="#tb_org_nav">Site<br>Map</a>
	        <!--<a class="model-tab" href="#tb_context_adaptation">Context &amp; Adaptation</a>-->
	    </aside>
	    <section id="data-model" class="tab">
	    		<!--<a id="common-elements" onclick="openElementPanel()">Common Elements</a>
	    		<a id="new-element" onclick="addElement()">New Element</a>-->
	    	<aside id="element_sidebar" class="manipulation-bar">
	    		<a class="toggle-bar" onclick="uiSidebarToggle(this.parentNode);">S</a>

				<label for="current_class_name">Name</label>
				<input type="text" id="current_class_name" onchange="alert('')">
				<h3>Properties</h3>
				<div id="attibs_editable"></div>
				<script>
					if(app.currentElement != null){
						_.each(app.classes.models, function(c) {
							if(c.id === app.currentElement.id){
								_.each(c.attributes.attributes, function(c) {
									$("div#attibs_editable").append("<span>" + c + "</span>");
								});
							}
						});
					}
				</script>
				<button id="add_attrib">Add Process</button>
			</aside>
	    	<div id="class_diagram" class="diagram_paper"></div>

	    </section>

	    <section id="tb_data_model">

			<div id="data_model"  class="tab">
			</div>
			<script type="text/javascript">

				var processDispTemplate = "<div class=\"process_display\">"
						+ "${name} <br>"
						+ "I : ${inputs}<br>"
						+ "O : ${output}<br>"
						+ "</div>";

				var processDrawTemplate = "<div id=\"${id}\" class=\"process_display\">"
						+ "${name} <br>"
						+ "I : ${inputs}<br>"
						+ "O : ${output}<br>"
						+ "</div>";

            $(document).ready(function() {
		    		$("#upload").click(function(event) {
		    			for(page in app.pages.models){
		    				app.pages.models[page].attributes.nestedContainers = app.pages.models[page].attributes.ref.getEmbeddedCells();
		    			}
		    			var data = [app.classes, app.relationships, app.processes, app.sessionVars, app.userGroups, app.pages, app.links];
			    		$.ajax
		                ({
		                    type: "post",
		                    url: "http://localhost:8080/nucleus",
		                    dataType: "json",
		                    contentType: "application/json; charset=UTF-8",
		                    data: JSON.stringify(data)
		                }).done(function(data){
		                	alert("ajax callback response:" + data);
		                });
				    });
				});
			function init(){
				app.selectionMode = true;
				app.userGroups.push({name : 'public'});
				$("#new_user_button").before("<span>Public</span>");

				refresh();
			}
			function refresh(){
				//attribview

				$("div#class_attribs").empty();

				var distRows = "";
				_.each(app.classes.models, function(c) {
					$("div#class_attribs").append("<div class=\"class_attrib_view\">"
							+ "<div class=\"class_representation c.attributes.type\">" + c.attributes.name + "</div>" +
						"</div>");
						distRows += permissionField.replace("${classname}", c.attributes.name);
					_.each(c.attributes.attributes, function(c) {
						$("div#class_attribs div.class_attrib_view:last").append("<span>" + c + "</span>");
					});
					$("div#class_attribs div.class_attrib_view:last").append("<button class=\"mini\"onclick=\"newDerivedAttrib(\'" + c.attributes.name + "\')\">+</button>");
				});

				distTable = distTableTemplate.replace("${rows}", distRows);

				_.each(app.classes.models, function(c) { graph.addCell(c); });

				unselectElements();

				_.each(app.relationships.models, function(r){ graph.addCell(r); });

				$("#process_pool").empty();
				for(process in app.processes){
					$("#process_pool").append(processDispTemplate.replace("${name}", app.processes[process].name).replace("${inputs}", app.processes[process].input).replace("${output}", app.processes[process].output));
				}
			}
				var graph = new joint.dia.Graph();

				var paper = new joint.dia.Paper({
				    el: $('#class_diagram'),
				    width: 1200,
				    height: 1000,
				    gridSize: 1,
				    model: graph
				});

				paper.on('cell:pointerclick', function(cellView, el) {
					selectElement(cellView.model);
				});

				paper.on('blank:pointerclick', function(evt, x, y) {
    				unselectElements();
				});

				var selected;

				paper.on('cell:pointerup', function(cellView, evt, x, y) {

					var dropped = graph.getCell(cellView.model.id);
					var elementBelow = graph.get('cells').find(function(cell) {
				        if (cell instanceof joint.dia.Link) return false;
				        if (cell.id === cellView.model.id) return false;
				        if (cell.getBBox().containsPoint(g.point(x, y))) {

				            return true;
				        }

				        return false;

				    });

				    if(dropped instanceof joint.dia.Link){

				    	switch(dropped.attributes.type){
				    		case 'uml.Association' :
				    			if(dropped.attributes.target.id == elementBelow.attributes.id){
				    				var min = prompt("Enter min");
				    				var max = prompt("Enter max");

				    				var labelStr = (min == max) ? max : min + ".." + max;
				    				var lblPosition = .9;
				    				if(labelStr != '1'){
				    					if(typeof dropped.attributes.labels == 'undefined')
				    					dropped.label(0, {
										    position: .1,
										    attrs: {
										        text: { text : '' }
										    }
										});

					    				dropped.label(1, {
										    position: lblPosition,
										    attrs: {
										        rect: { fill: 'white' },
										        text: { fill: 'blue', text : labelStr }
										    }
										});
				    				}
				    			}
				    		case 'uml.Aggregation' :
				    		case 'uml.Composition' :
				    			if(dropped.attributes.source.id == elementBelow.attributes.id){
				    				var min = prompt("Enter min");
				    				var max = prompt("Enter max");

				    				var labelStr = (min == max) ? max : min + ".." + max;
				    				var lblPosition = .1;
				    				if(labelStr != '1'){
					    				dropped.label(0, {
										    position: lblPosition,
										    attrs: {
										        rect: { fill: 'white' },
										        text: { fill: 'blue', text : labelStr }
										    }
										});
				    				}
				    			}
				    			break;
				    	}
				    }

				});
			function addProcess(pName, inputs, output){
				if(pName == '' || inputs == '' || output == '') return;
			    app.processes.push({name : pName, input : inputs, output : output});
			    refresh();
			}

			</script>

		</section>

		<div id="class_attrib" title="New Property">
			<form>
				<label for="prop_name">Name</label>
				<input type="text" id="prop_name" name="prop_name">
				<label for="prop_data_type">DataType</label>
				<select id="prop_data_type" name="prop_data_type">
					<option>String</option>
					<option>String[]</option>
					<option>Integer</option>
					<option>Integer[]</option>
					<option>Real</option>
					<option>Real[]</option>
					<option>Boolean</option>
					<option>Boolean[]</option>
				</select>
			</form>
		</div>

		<section id="tb_derived_data">
			<div id="class_attribs" class="tab">
			</div>
				<script>
					function findClassById(id){
						return _.find(app.classes.models, function(model){ return model.attributes.id  === id });
					}
					function addConstant(classRef){
						var constantName = prompt('Enter Constant Name');
						var dataType = prompt('Enter Constant Data Type');
						addAttrib($("#dialog").data('ref'), "+", constantName.toUpperCase(), dataType);
					}
					function addImportedAttrib(className){
						var classRef = _.find(app.classes.models, function(model){ return model.attributes.name  === $("#dialog").data('ref') });
						var candidates = '';
						for(relationship in app.relationships.models){
							if(classRef.attributes.id === app.relationships.models[relationship].attributes.target.id) candidates += findClassById(app.relationships.models[relationship].attributes.source.id).attributes.name + " (" + app.relationships.models[relationship].attributes.type + " : targetOf)";
							else if(classRef.attributes.id === app.relationships.models[relationship].attributes.source.id) candidates += findClassById(app.relationships.models[relationship].attributes.target.id).attributes.name + " (" + app.relationships.models[relationship].attributes.type + " : sourceOf)";
						}

						alert($("#dialog").data('ref') + " : " + candidates);
					}
					function addAggregate(classRef){
						var classRef = _.find(app.classes.models, function(model){ return model.attributes.name  === $("#dialog").data('ref') });
						var candidates = '';
						for(relationship in app.relationships.models){
							if(classRef.attributes.id === app.relationships.models[relationship].attributes.target.id) candidates += app.relationships.models[relationship].attributes.target;
							else if(classRef.attributes.id === app.relationships.models[relationship].attributes.source.id) candidates += app.relationships.models[relationship].attributes.source;
						}
						alert(candidates);
					}
					function addCalculatedAttrib(classRef){
						var calculatedValues = prompt('Enter Calculated value Name');
					}
				</script>
				<div id="dialog" title="Derived Attributes">
  					<button onclick="addConstant()">Constant</button>
  					<button onclick="addImportedAttrib()">Imported Attrib</button>
  					<button onclick="addAggregate()">Aggregate Attrib</button>
  					<button onclick="addCalculatedAttrib()">Calculated Attrib</button>
				</div>
			<script>
					$(function() {

						$( "#class_attrib" ).dialog({
						modal : true,
					   	autoOpen: false,
					   	position: { my: "center", at: "center", of: $("#data_model") },
					   	buttons: {
					     	Add: function() {
					        	addAttrib(app.currentElement.attributes.name, , $("#prop_name").val() , $("#prop_data_type").val());
					        	$( this ).dialog( "close" );
					        },
					        Cancel: function() {
					        	$( this ).dialog( "close" );
					        }
					      	}
						});

						$("#dialog").dialog({
						modal : true,
					   	autoOpen: false,
					   	position: { my: "center", at: "center", of: $("#tb_derived_data") }
					    });
					});
				refresh();

				function attribDialog(){
					$( "#class_attrib" ).dialog( "open" );

				}
			</script>
		</section>

		</section>
		<section id="tb_processes" class="tab">
			<div id="process_pool"></div>

			<div id="dialog-form" title="Create Process">
			  <form>
			    <fieldset>
			      <label for="pro_name">Name</label>
			      <input type="text" name="pro_name" id="pro_name" value="" class="text ui-widget-content ui-corner-all"><br>
			      <label for="inputs">Inputs list</label>
			      <input type="text" name="inputs" id="inputs" value="" class="text ui-widget-content ui-corner-all"><br>
			      <label for="output">Output</label>
			      	<select name="output" id="output" class="text ui-widget-content ui-corner-all">
			    		<option value="text">Text</option>
			    		<option value="integer">Interger</option>
			    		<option value="real">Real</option>
			    		<option value="boolean">Boolean</option>
			    	</select>
			      <br>

			      <!-- Allow form submission with keyboard without duplicating the dialog button -->
			      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
			    </fieldset>
			  </form>
			</div>
			<script>

			  $(function() {
			    var dialog, form, allFields = $( [] ).add( $( "#pro_name" ) );

			    function newProcess() {
			      allFields.removeClass( "ui-state-error" );
			        addProcess($( "#pro_name" ).val(), $( "#inputs" ).val(), $( "#output" ).val());
			        dialog.dialog( "close" );
			        return true;
			    }

			    dialog = $( "#dialog-form" ).dialog({
			      autoOpen: false,
			      height: 300,
			      width: 350,
			      modal: true,
			      position: { my: "center", at: "center", of: $("#tb_processes") },
			      buttons: {
			        "Create Process": newProcess,
			        Cancel: function() {
			          dialog.dialog( "close" );
			        }
			      },
			      close: function() {
			        //form[ 0 ].reset();
			        allFields.removeClass( "ui-state-error" );
			      }
			    });

			    form = dialog.find( "#dialog-form" ).on( "submit", function( event ) {
			      event.preventDefault();
			      addUser();
			    });

			    $( "#create-process" ).button().on( "click", function() {
			      dialog.dialog( "open" );
			    });
			  });
			</script>

			<button id="create-process" style="width: 50%;">New Process</button>
		</section>
		<section id="tb_distribution" class="tab">
		</section>
		<section id="tb_org_nav" class="tab">
			<aside id="paging_sidebar" class="manipulation-bar">
				<div id="org_bar">
					<h3>Presentation</h3>
					<button onclick="addArea('Area')">Add Area</button>
					<button onclick="addPage('Page')">Add Page</button>
					<button onclick="addLandmarkPage('LPage')">Add LandmarkPage</button>
					<button onclick="addHomePage()">Add HomePage</button>
					<button onclick="addModule()">Add Module</button>
					<button id="draw_unit">Add Unit</button>
					<button id="draw_process">Add Process</button>
					<!--<h3>Context &amp; Adaptation</h3>-->
				</div>
				<div id="navca_bar" class="hidden_bar">
				<!--render bar-->
					<button onclick="scaleUp()">Scale Up</button>
					<button onclick="scaleDown()">Scale Down</button>

					<h3>Navigation</h3>
					<button onclick="addNCLink()">Non-Contexual Link</button>
					<button onclick="addTransLink()">Transport Link</button>
					<button onclick="addAutoLink('Link', 'A')">Automatic Link</button>
					<form>

					</form>
				</div>
			</aside>
			<div id="site_map_draw" style="posi" class="diagram_paper"></div>
			<script>

				function scaleUp(){
					current_SMElement.resize(current_SMElement.attributes.size.width * 1.1 , current_SMElement.attributes.size.height * 1.1);
				}
				function scaleDown(){
					current_SMElement.resize(current_SMElement.attributes.size.width * (10 / 11) , current_SMElement.attributes.size.height * (10 / 11));
				}

				var org_nav_graph = new joint.dia.Graph();

				var org_graph_paper = new joint.dia.Paper({
				    el: $('#site_map_draw'),
				    width: 5000,
				    height: 5000,
				    gridSize: 1,
				    model: org_nav_graph
				});

				org_graph_paper.on('cell:pointerclick', function(cellView, el) {
					renderNavCABar();
					selectSMElement(cellView.model);
				});

				org_graph_paper.on('blank:pointerclick', function(evt, x, y) {
					renderOrgBar();
    				unselectSMElement();
				});

				org_graph_paper.on('cell:pointerup', function(cellView, evt, x, y) {

					var elementBelow = _.sortBy(org_nav_graph.get('cells').models, function(cell){ return(10 - cell.attributes.z) }).find(function(cell) {
					        if (cell instanceof joint.dia.Link) return false;
					        if (cell.id === cellView.model.id) return false;
					        if (cell.getBBox().containsPoint(g.point(x, y))) {
					            return true;
					        }
					        return false;

					});

					if(elementBelow != null){
						childElement = org_nav_graph.getCell(cellView.model.id);
						if(elementBelow.attributes.type === 'Area' && childElement.attributes.type === 'Page'
						|| elementBelow.attributes.type === 'Area' && childElement.attributes.type === 'LandmarkPage'
						|| elementBelow.attributes.type === 'Area' && childElement.attributes.type === 'HomePage'
						|| elementBelow.attributes.type === 'Area' && childElement.attributes.type === 'Process'
						|| elementBelow.attributes.type === 'Page' && childElement.attributes.type === 'Module'
						|| elementBelow.attributes.type === 'LandmarkPage' && childElement.attributes.type === 'Module'
						|| elementBelow.attributes.type === 'HomePage' && childElement.attributes.type === 'Module'
						|| elementBelow.attributes.type === 'Page' && childElement.attributes.type === 'Unit'
						|| elementBelow.attributes.type === 'LandmarkPage' && childElement.attributes.type === 'Unit'
						|| elementBelow.attributes.type === 'HomePage' && childElement.attributes.type === 'Unit'){
							elementBelow.embed(childElement);
						}
					}

				});

				org_nav_graph.on('change:position', function(cell) {
					if(cell.getAncestors()[0] == null) return;

				    var parentBbox = cell.getAncestors()[0].getBBox();
				    var cellBbox = cell.getBBox();

				    if (parentBbox.containsPoint(cellBbox.origin()) &&
				        parentBbox.containsPoint(cellBbox.topRight()) &&
				        parentBbox.containsPoint(cellBbox.corner()) &&
				        parentBbox.containsPoint(cellBbox.bottomLeft())) {

				        return;
				    }

    				cell.set('position', cell.previous('position'));
				});

				$(function() {
    				$( "#process_units" ).dialog({
						modal : true,
					   	autoOpen: false,
					   	position: { my: "center", at: "center", of: $("#site_map_draw") }
					});

	  				$( "#draw_process" ).button().on( "click", function() {
	  					$("#process_units").empty();
	  					for(process in app.processes){
							$("#process_units").append("<a id=\"pro_unit_" + app.processes[process].name + "\" class=\"button\" href=\"#\">" + processDrawTemplate.replace("${id}", app.processes[process].name).replace("${name}", app.processes[process].name).replace("${inputs}", app.processes[process].input).replace("${output}", app.processes[process].output) + "</a>");
							$( "#pro_unit_" + app.processes[process].name).button()
						      .click(function( event ) {
						      	hanoi = event;
						        event.preventDefault();
						        $( "#process_units" ).dialog( "close" );
						        addProcessUnit(event.target.id);
					    	});
						}
				      $( "#process_units" ).dialog( "open" );
				    });

				    $( "#units" ).dialog({
						modal : true,
					   	autoOpen: false,
					   	position: { my: "center", at: "center", of: $("#site_map_draw") },
					   	buttons: {
					     	Add: function() {
					        	addUnit($( "#unitLbl" ).val(), $( "#unitType" ).val(), $( "#mapTo" ).val(), $( "#unitParam" ).val());
					        	$( this ).dialog( "close" );
					        },
					        Cancel: function() {
					        	$( this ).dialog( "close" );
					        }
					      	}
					});

	  				$( "#draw_unit" ).button().on( "click", function() {
	  					$( "#units #mapTo" ).empty();
	  					for(classRef in app.classes.models){
	  						if(app.classes.models[classRef].attributes.type != "uml.Interface"){
	  							$( "#units select" ).append("<option>" + app.classes.models[classRef].attributes.name + "</option>");
	  						}
	  					}
				      	$( "#units" ).dialog( "open" );
				    });

			    });

				function loadAttribs(){

				}

			</script>
			<div id="process_units" title="Processes">

			</div>

			<div id="units" title="Units">
				<form>
					<label for="unitLbl">Name</label>
					<input type="text" name="unitLbl" id="unitLbl">
					<label for="unitType">Type</label>
					<select id="unitType" name="unitType">
						<option>Data Unit</option>
						<option>Multi Data Unit</option>
						<option>Index Unit</option>
						<option>Index Unit - MulitiChoice</option>
						<option>Index Unit - Hierachical</option>
						<option>Entry Unit</option>
					</select>
					<label for="mapTo">Map to Class</label>
					<select id="mapTo">
					</select>
				</form>
			</div>
		</section>
		<!--<section id="tb_context">
						context
		</section>
		<section id="tb_adaptation">
						adaptation
		</section>
		<section id="tb_generated">
		                WebML
		</section> -->
	</body>
</html>
